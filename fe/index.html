<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Face Liveness / Spoof Checker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0b1020;
      --bg-soft: #141a2b;
      --bg-softer: #1c2435;
      --accent: #4f46e5;
      --accent-soft: rgba(79, 70, 229, 0.1);
      --accent-strong: #f97316;
      --text: #f9fafb;
      --text-soft: #9ca3af;
      --border: #1f2937;
      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.12);
      --success: #22c55e;
      --success-soft: rgba(34, 197, 94, 0.12);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
                   "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
      display: flex;
      justify-content: center;
    }

    .app {
      max-width: 1200px;
      width: 100%;
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.12), rgba(8, 47, 73, 0.6));
      border-radius: 24px;
      padding: 1px;
      box-shadow:
          0 18px 40px rgba(0, 0, 0, 0.65),
          0 0 0 1px rgba(148, 163, 184, 0.15);
    }

    .app-inner {
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.05), transparent 60%),
                  radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.05), transparent 55%),
                  var(--bg);
      border-radius: 23px;
      padding: 24px 24px 20px;
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      align-items: center;
      margin-bottom: 24px;
    }

    .app-title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .app-title {
      font-size: 24px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-title span.icon {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #facc15, transparent 55%),
                  radial-gradient(circle at 70% 120%, #f97316, #dc2626);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      box-shadow: 0 0 0 1px rgba(248, 250, 252, 0.2);
    }

    .app-subtitle {
      font-size: 14px;
      color: var(--text-soft);
    }

    .app-badge {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text-soft);
      background: radial-gradient(circle at top, rgba(148, 163, 184, 0.15), transparent 60%);
    }

    .app-badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.12), transparent 60%),
                  var(--bg-soft);
      border-radius: var(--radius-lg);
      padding: 16px;
      border: 1px solid rgba(31, 41, 55, 0.8);
      box-shadow: 0 10px 28px rgba(15, 23, 42, 0.85);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title-pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(75, 85, 99, 0.6);
      color: var(--text-soft);
    }

    .card-subtitle {
      font-size: 12px;
      color: var(--text-soft);
    }

    .form-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    label {
      font-size: 12px;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    select, input[type="file"] {
      width: 100%;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      font-size: 13px;
      outline: none;
    }

    select:focus, input[type="file"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.7);
    }

    .radio-group {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      gap: 3px;
      font-size: 12px;
    }

    .radio-pill {
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      user-select: none;
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .radio-pill.active {
      background: linear-gradient(135deg, var(--accent), #0ea5e9);
      color: #f9fafb;
      box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.8);
    }

    .radio-pill span.icon {
      font-size: 14px;
    }

    .btn-primary {
      width: 100%;
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: white;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 15px 32px rgba(79, 70, 229, 0.7);
      transition: transform 0.07s ease, box-shadow 0.07s ease, filter 0.07s ease;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 20px 40px rgba(79, 70, 229, 0.9);
    }

    .btn-primary:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 12px 26px rgba(79, 70, 229, 0.6);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .btn-primary .spinner {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(248, 250, 252, 0.25);
      border-top-color: #f9fafb;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .preview-box {
      border-radius: var(--radius-md);
      border: 1px dashed rgba(75, 85, 99, 0.9);
      padding: 10px;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.7);
      overflow: hidden;
      position: relative;
    }

    .preview-box img,
    .preview-box video {
      max-width: 100%;
      max-height: 260px;
      border-radius: 12px;
      display: block;
    }

    .preview-placeholder {
      font-size: 13px;
      color: var(--text-soft);
      text-align: center;
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
    }

    .preview-placeholder span.icon {
      font-size: 24px;
    }

    .tag {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(55, 65, 81, 0.7);
      color: var(--text-soft);
    }

    .result-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .result-badge-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: currentColor;
    }

    .result-label-live {
      background: var(--success-soft);
      border-color: var(--success);
      color: var(--success);
    }

    .result-label-spoof {
      background: var(--danger-soft);
      border-color: var(--danger);
      color: var(--danger);
    }

    .result-label-none {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(55, 65, 81, 0.8);
      color: var(--text-soft);
    }

    .metric-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 8px;
    }

    .metric {
      flex: 1 1 90px;
      min-width: 90px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      font-size: 12px;
    }

    .metric-label {
      color: var(--text-soft);
      margin-bottom: 2px;
    }

    .metric-value {
      font-weight: 600;
      font-size: 13px;
    }

    .hint {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 6px;
    }

    .history {
      margin-top: 10px;
      font-size: 12px;
    }

    .history-item {
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.85);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .history-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .history-line-main {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .history-line-main strong {
      font-weight: 600;
    }

    .history-timestamp {
      color: var(--text-soft);
      font-size: 11px;
    }

    .pill {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.8);
    }

    .pill-live {
      border-color: var(--success);
      color: var(--success);
      background: var(--success-soft);
    }

    .pill-spoof {
      border-color: var(--danger);
      color: var(--danger);
      background: var(--danger-soft);
    }

    .pill-image {
      color: #60a5fa;
      border-color: #60a5fa;
      background: rgba(37, 99, 235, 0.16);
    }

    .pill-video {
      color: #a855f7;
      border-color: #a855f7;
      background: rgba(147, 51, 234, 0.16);
    }

    .badge-model {
      font-size: 11px;
      color: var(--text-soft);
    }

    .text-muted {
      color: var(--text-soft);
    }

    .text-danger {
      color: var(--danger);
    }

    .text-success {
      color: var(--success);
    }

    .alert {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .alert-warning {
      border-color: #f97316;
      background: rgba(248, 171, 96, 0.14);
      color: #fed7aa;
    }

    .alert-error {
      border-color: var(--danger);
      background: rgba(239, 68, 68, 0.12);
      color: #fecaca;
    }

    .alert-info {
      border-color: #38bdf8;
      background: rgba(56, 189, 248, 0.1);
      color: #bae6fd;
    }

    .footer {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px solid rgba(31, 41, 55, 0.7);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-soft);
    }

    .footer span.highlight {
      color: #e5e7eb;
    }

    @media (max-width: 900px) {
      body {
        padding: 12px;
      }
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
      .app-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="app-inner">
      <header class="app-header">
        <div class="app-title-block">
          <div class="app-title">
            <span class="icon">üë§</span>
            <span>Face Liveness / Spoof Checker</span>
          </div>
          <div class="app-subtitle">
            Ki·ªÉm tra nhanh ·∫£nh ho·∫∑c video xem l√† <strong>m·∫∑t th·∫≠t (live)</strong> hay <strong>gi·∫£ m·∫°o (spoof)</strong>.
          </div>
        </div>
        <div class="app-badge">
          <span class="app-badge-dot"></span>
          Frontend ƒë√£ s·∫µn s√†ng k·∫øt n·ªëi FastAPI
        </div>
      </header>

      <div class="layout">
        <!-- C·ªòT TR√ÅI: INPUT & PREVIEW -->
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                C·∫•u h√¨nh ki·ªÉm tra
                <span class="card-title-pill">Client-side UI</span>
              </div>
              <div class="card-subtitle">
                Ch·ªçn model, lo·∫°i input v√† upload ·∫£nh / video ƒë·ªÉ ph√¢n t√≠ch.
              </div>
            </div>
          </div>

          <div class="form-grid">
            <!-- Ch·ªçn model -->
            <div>
              <label for="modelSelect">1Ô∏è Ch·ªçn model liveness</label>
              <select id="modelSelect">
                <!-- value = VisionTriX ƒë·ªÉ backend d√πng; text = Hybrid-CDCN-ResViT ƒë·ªÉ hi·ªÉn th·ªã -->
                <option value="VisionTriX">Hybrid-CDCN-ResViT</option>
                <option value="MobileNetV3">MobileNetV3</option>
              </select>
            </div>

            <!-- Ch·ªçn lo·∫°i input -->
            <div>
              <label>2Ô∏è Ch·ªçn lo·∫°i input</label>
              <div class="radio-group" id="inputTypeGroup">
                <div class="radio-pill active" data-value="image">
                  <span class="icon">üì∑</span> ·∫¢nh
                </div>
                <div class="radio-pill" data-value="video">
                  <span class="icon">üé•</span> Video
                </div>
              </div>
            </div>

            <!-- Input file -->
            <div>
              <label for="fileInput">3Ô∏è T·∫£i file l√™n</label>
              <input id="fileInput" type="file" />
              <div class="hint">
                ·∫¢nh h·ªó tr·ª£: <span class="tag">.jpg</span> <span class="tag">.jpeg</span> <span class="tag">.png</span> ‚Ä¢
                Video h·ªó tr·ª£: <span class="tag">.mp4</span> <span class="tag">.mov</span> <span class="tag">.avi</span>
              </div>
            </div>

            <!-- Preview -->
            <div>
              <label>4Ô∏è Xem preview</label>
              <div class="preview-box" id="previewBox">
                <div class="preview-placeholder">
                  <span class="icon">‚ú®</span>
                  Ch∆∞a c√≥ file. H√£y ch·ªçn <strong>·∫¢nh</strong> ho·∫∑c <strong>Video</strong> v√† upload ƒë·ªÉ xem tr∆∞·ªõc.
                </div>
              </div>
            </div>

            <!-- N√∫t ph√¢n t√≠ch -->
            <div>
              <button class="btn-primary" id="analyzeButton">
                <span id="analyzeButtonIcon">üöÄ</span>
                <span id="analyzeButtonText">Ph√¢n t√≠ch</span>
              </button>
              <div id="messageBox"></div>
            </div>
          </div>
        </section>

        <!-- C·ªòT PH·∫¢I: K·∫æT QU·∫¢ & L·ªäCH S·ª¨ -->
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                K·∫øt qu·∫£ & b√°o c√°o
              </div>
              <div class="card-subtitle">
                K·∫øt qu·∫£ s·∫Ω ƒë∆∞·ª£c l·∫•y tr·ª±c ti·∫øp t·ª´ API FastAPI c·ªßa b·∫°n.
              </div>
            </div>
          </div>

          <!-- K·∫øt qu·∫£ hi·ªán t·∫°i -->
          <div id="resultArea">
            <div class="result-badge result-label-none" id="resultBadge">
              <span class="result-badge-dot"></span>
              <span id="resultLabel">Ch∆∞a c√≥ k·∫øt qu·∫£</span>
              <span id="resultScore" style="opacity:0.7;">‚Ä¢ Score spoof: N/A</span>
            </div>

            <div class="metric-row">
              <div class="metric">
                <div class="metric-label">Model</div>
                <div class="metric-value" id="metricModel">‚Äì</div>
              </div>
              <div class="metric">
                <div class="metric-label">Lo·∫°i input</div>
                <div class="metric-value" id="metricInputType">‚Äì</div>
              </div>
              <div class="metric">
                <div class="metric-label">Th·ªùi gian x·ª≠ l√Ω</div>
                <div class="metric-value" id="metricDuration">‚Äì</div>
              </div>
            </div>

            <div class="hint">
              üí° Backend tr·∫£ v·ªÅ: <code>{"status": "success", "type": "image|video", "model": "...", "class_name": "REAL|FAKE"}</code>  
              FE s·∫Ω map <code>REAL ‚Üí live</code>, <code>FAKE ‚Üí spoof</code>.
            </div>
          </div>

          <!-- L·ªãch s·ª≠ (ch·ªâ k·∫øt qu·∫£ l·∫ßn tr∆∞·ªõc) -->
          <div class="history">
            <div style="margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;">
              <span><strong>üßæ K·∫øt qu·∫£ l·∫ßn tr∆∞·ªõc</strong></span>
              <button id="clearHistoryBtn" style="
                font-size: 11px;
                padding: 4px 8px;
                border-radius: 999px;
                border: 1px solid rgba(75, 85, 99, 0.9);
                background: rgba(15, 23, 42, 0.9);
                color: var(--text-soft);
                cursor: pointer;
              ">Xo√°</button>
            </div>
            <div id="historyList" class="text-muted">
              Ch∆∞a c√≥ b·∫£n ghi n√†o tr∆∞·ªõc ƒë√≥.
            </div>
          </div>
        </section>
      </div>

      <footer class="footer">
        <div>
          Giao di·ªán tƒ©nh ‚Äì <span class="highlight">ƒë√£ n·ªëi s·∫µn API FastAPI (image / video predict)</span>.
        </div>
        <div>
          Backend: <code>POST /predict/image</code> & <code>POST /predict/video</code>
        </div>
      </footer>
    </div>
  </div>

    <script>
const API_BASE = "http://127.0.0.1:8000";
const APP_STATE_KEY = "dacn_app_state_v1";
const PREVIEW_KEY = "dacn_preview_img_v1";
const DB_NAME = "dacn_files_db";
const STORE_NAME = "files";
const IMAGE_SAVE_THRESHOLD = 2 * 1024 * 1024; // 2MB

// ===== state =====
const state = {
  inputType: "image",
  fileMeta: null,    // { id, name, size, type } persisted
  fileBlob: null,    // in-memory Blob for submission / preview
  history: [],       // array of records (recent)
  currentRecord: null,
  phase: "ready"     // ready | running | need_continue
};

// ===== DOM =====
const inputTypeGroup = document.getElementById("inputTypeGroup");
const fileInput = document.getElementById("fileInput");
const previewBox = document.getElementById("previewBox");
const analyzeButton = document.getElementById("analyzeButton");
const analyzeButtonText = document.getElementById("analyzeButtonText");
const analyzeButtonIcon = document.getElementById("analyzeButtonIcon");
const messageBox = document.getElementById("messageBox");
const resultBadge = document.getElementById("resultBadge");
const resultLabel = document.getElementById("resultLabel");
const resultScore = document.getElementById("resultScore");
const metricModel = document.getElementById("metricModel");
const metricInputType = document.getElementById("metricInputType");
const metricDuration = document.getElementById("metricDuration");
const historyList = document.getElementById("historyList");
const clearHistoryBtn = document.getElementById("clearHistoryBtn");
const modelSelect = document.getElementById("modelSelect");

// ===== IndexedDB helper =====
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: "id" });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function idbPut(obj) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, "readwrite");
    const store = tx.objectStore(STORE_NAME);
    const r = store.put(obj);
    r.onsuccess = () => resolve(obj.id);
    r.onerror = () => reject(r.error);
  });
}
async function idbGet(id) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, "readonly");
    const store = tx.objectStore(STORE_NAME);
    const r = store.get(id);
    r.onsuccess = () => resolve(r.result);
    r.onerror = () => reject(r.error);
  });
}
async function idbDelete(id) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, "readwrite");
    const store = tx.objectStore(STORE_NAME);
    const r = store.delete(id);
    r.onsuccess = () => resolve();
    r.onerror = () => reject(r.error);
  });
}

// ===== persistence =====
function saveAppState() {
  try {
    const toSave = {
      inputType: state.inputType,
      model: modelSelect.value,
      phase: state.phase,
      fileMeta: state.fileMeta,
      history: state.history.slice(-50), // keep recent 50
      currentRecord: state.currentRecord
    };
    localStorage.setItem(APP_STATE_KEY, JSON.stringify(toSave));
  } catch (e) {
    console.warn("saveAppState failed", e);
  }
}
async function loadAppState() {
  try {
    const raw = localStorage.getItem(APP_STATE_KEY);
    if (!raw) return;
    const s = JSON.parse(raw);
    if (s.inputType) {
      state.inputType = s.inputType;
      inputTypeGroup.querySelectorAll(".radio-pill").forEach(p => p.classList.remove("active"));
      const pill = inputTypeGroup.querySelector(`.radio-pill[data-value="${s.inputType}"]`);
      if (pill) pill.classList.add("active");
    }
    if (s.model) modelSelect.value = s.model;
    state.phase = s.phase || "ready";
    state.history = s.history || [];
    state.currentRecord = s.currentRecord || null;
    state.fileMeta = s.fileMeta || null;

    if (state.currentRecord) updateResultFromApi(state.currentRecord);
    renderHistory();

    // restore blob if fileMeta present
    if (state.fileMeta && state.fileMeta.id) {
      const rec = await idbGet(state.fileMeta.id);
      if (rec && rec.blob) {
        state.fileBlob = rec.blob;
        renderBlobPreview(rec.blob, rec.name, state.inputType);
      }
    } else {
      // try small preview from localStorage
      tryRestorePreviewImage();
    }
  } catch (e) {
    console.warn("loadAppState error", e);
  } finally {
    setLoading(false);
  }
}

// small image preview saved as dataURL
function trySavePreviewImage(file) {
  if (!file || state.inputType !== "image" || file.size > IMAGE_SAVE_THRESHOLD) {
    localStorage.removeItem(PREVIEW_KEY);
    return;
  }
  const r = new FileReader();
  r.onload = () => {
    try { localStorage.setItem(PREVIEW_KEY, r.result); } catch (e) { /* ignore */ }
  };
  r.readAsDataURL(file);
}
function tryRestorePreviewImage() {
  const data = localStorage.getItem(PREVIEW_KEY);
  if (!data) return false;
  previewBox.innerHTML = "";
  const img = document.createElement("img");
  img.src = data;
  img.alt = "Preview (restored)";
  previewBox.appendChild(img);
  return true;
}

// save file blob into IDB with generated id
async function saveFileBlob(file) {
  try {
    const id = crypto.randomUUID ? crypto.randomUUID() : "fid_" + Date.now();
    const obj = { id: id, name: file.name || "file", size: file.size || file.size, type: file.type || "", blob: file };
    await idbPut(obj);
    return { id, name: obj.name, size: obj.size, type: obj.type };
  } catch (e) {
    console.warn("saveFileBlob failed", e);
    return null;
  }
}
async function removeFileBlob(id) {
  try { await idbDelete(id); } catch (e) { console.warn(e); }
}

// ===== UI helpers =====
function showMessage(text, type = "info") {
  const classMap = { info: "alert alert-info", warning: "alert alert-warning", error: "alert alert-error" };
  messageBox.innerHTML = `<div class="${classMap[type]}">${text}</div>`;
}
function renderBlobPreview(blob, filename, type) {
  const url = URL.createObjectURL(blob);
  previewBox.innerHTML = "";
  if (type === "image" || (blob.type && blob.type.startsWith("image"))) {
    const img = document.createElement("img");
    img.src = url;
    img.alt = filename || "Preview Image";
    previewBox.appendChild(img);
  } else {
    const video = document.createElement("video");
    video.src = url;
    video.controls = true;
    video.loop = true;
    video.muted = true;
    previewBox.appendChild(video);
  }
}
function renderPreviewPlaceholder() {
  previewBox.innerHTML = `
    <div class="preview-placeholder">
      <span class="icon">${state.inputType === "image" ? "üì∑" : "üé•"}</span>
      Ch∆∞a c√≥ file. H√£y upload m·ªôt ${state.inputType === "image" ? "·∫£nh" : "video"} ƒë·ªÉ xem tr∆∞·ªõc.
    </div>
  `;
}

// unified loading button
function setLoading(isLoading) {
  if (isLoading) {
    analyzeButton.disabled = true;
    analyzeButtonIcon.innerHTML = "";
    analyzeButtonIcon.classList.add("spinner");
    analyzeButtonText.textContent = "ƒêang ph√¢n t√≠ch...";
  } else {
    analyzeButton.disabled = false;
    analyzeButtonIcon.classList.remove("spinner");
    if (state.phase === "need_continue") {
      analyzeButtonIcon.textContent = "‚è≠";
      analyzeButtonText.textContent = "Ti·∫øp t·ª•c";
    } else {
      analyzeButtonIcon.textContent = "üöÄ";
      analyzeButtonText.textContent = "Ph√¢n t√≠ch";
    }
  }
}

// ===== file input handler (single) =====
fileInput.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) {
    state.fileBlob = null;
    if (state.fileMeta && state.fileMeta.id) { await removeFileBlob(state.fileMeta.id); }
    state.fileMeta = null;
    renderPreviewPlaceholder();
    trySavePreviewImage(null);
    saveAppState();
    return;
  }

  state.fileBlob = file;
  // save to IDB for persistence (video or large image)
  const meta = await saveFileBlob(file);
  if (meta) {
    state.fileMeta = meta;
  } else {
    // fallback: clear meta but keep blob in-memory
    state.fileMeta = null;
  }

  // also save small image preview if applicable
  trySavePreviewImage(file);
  renderBlobPreview(file, file.name, state.inputType);
  saveAppState();
});

// input type switch
inputTypeGroup.addEventListener("click", (e) => {
  const pill = e.target.closest(".radio-pill");
  if (!pill) return;
  const value = pill.getAttribute("data-value");
  if (!value) return;
  state.inputType = value;
  inputTypeGroup.querySelectorAll(".radio-pill").forEach(p => p.classList.remove("active"));
  pill.classList.add("active");
  // when switching type, clear file selection (safer)
  fileInput.value = "";
  state.fileBlob = null;
  if (state.fileMeta && state.fileMeta.id) { removeFileBlob(state.fileMeta.id); state.fileMeta = null; }
  renderPreviewPlaceholder();
  showMessage("ƒê√£ chuy·ªÉn sang ch·∫ø ƒë·ªô " + (value === "image" ? "·∫¢nh" : "Video") + ".", "info");
  saveAppState();
});

// ===== analyze button =====
analyzeButton.addEventListener("click", async () => {
  if (state.phase === "need_continue") {
    state.phase = "ready";
    setLoading(false);
    showMessage("B·∫°n c√≥ th·ªÉ ch·ªçn testcase ti·∫øp theo r·ªìi b·∫•m Ph√¢n t√≠ch ƒë·ªÉ ch·∫°y.", "info");
    saveAppState();
    return;
  }
  if (state.phase === "running") return;
  if (!state.fileBlob) { showMessage("Vui l√≤ng ch·ªçn m·ªôt file tr∆∞·ªõc khi ph√¢n t√≠ch.", "warning"); return; }

  state.phase = "running";
  setLoading(true);
  showMessage("ƒêang g·ª≠i d·ªØ li·ªáu l√™n server...", "info");
  const start = performance.now();

  try {
    const endpoint = state.inputType === "image" ? "/predict/image" : "/predict/video";
    const formData = new FormData();
    // append blob with filename
    const filename = state.fileMeta?.name || (state.fileBlob.name || `upload_${Date.now()}`);
    formData.append("file", state.fileBlob, filename);
    formData.append("model_name", modelSelect.value);

    const resp = await fetch(`${API_BASE}${endpoint}`, { method: "POST", body: formData });
    let raw;
    try { raw = await resp.json(); } catch (e) { showMessage("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c JSON t·ª´ server.", "error"); return; }

    if (!resp.ok || raw.status !== "success") {
      const msg = raw && raw.error ? raw.error : "Server tr·∫£ v·ªÅ l·ªói kh√¥ng x√°c ƒë·ªãnh.";
      showMessage("L·ªói t·ª´ server: " + msg, "error");
      return;
    }

    const className = raw.class_name || raw.className || raw.class || "UNKNOWN";
    const label = className === "REAL" ? "live" : className === "FAKE" ? "spoof" : "unknown";
    const durationMs = raw.duration_ms ?? Math.round(performance.now() - start);
    const score = raw.score ?? (raw.probability ?? null);

    const rec = {
      id: crypto.randomUUID ? crypto.randomUUID() : "r" + Date.now(),
      timestamp: new Date().toISOString(),
      label,
      score,
      duration_ms: durationMs,
      model: modelSelect.value,
      inputType: state.inputType
    };

    // keep history bounded
    state.history = (state.history || []).concat([rec]).slice(-50);
    state.currentRecord = rec;
    state.phase = "need_continue";

    updateResultFromApi(rec);
    renderHistory();
    saveAppState();
    showMessage("ƒê√£ nh·∫≠n k·∫øt qu·∫£. Nh·∫•n 'Ti·∫øp t·ª•c' ƒë·ªÉ s·∫µn s√†ng cho testcase ti·∫øp theo.", "info");
  } catch (err) {
    console.error(err);
    showMessage("ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh g·ªçi API.", "error");
  } finally {
    setLoading(false);
  }
});

// ===== update UI functions =====
function updateResultFromApi(data) {
  const label = (data.label || "").toLowerCase();
  const score = data.score !== null && data.score !== undefined ? data.score : "N/A";
  const durationMs = data.duration_ms ?? data.durationMs ?? "N/A";

  resultBadge.classList.remove("result-label-live", "result-label-spoof", "result-label-none");
  if (label === "live") { resultBadge.classList.add("result-label-live"); resultLabel.textContent = "TH·∫¨T (LIVE)"; }
  else if (label === "spoof") { resultBadge.classList.add("result-label-spoof"); resultLabel.textContent = "GI·∫¢ M·∫†O (SPOOF)"; }
  else { resultBadge.classList.add("result-label-none"); resultLabel.textContent = "Kh√¥ng x√°c ƒë·ªãnh"; }

  resultScore.textContent = `‚Ä¢ Score spoof: ${score}`;
  metricModel.textContent = modelSelect.options[modelSelect.selectedIndex].text;
  metricInputType.textContent = state.inputType === "image" ? "·∫¢nh" : "Video";
  metricDuration.textContent = `${durationMs} ms`;
}

function addHistoryRecord(data) {
  // deprecated: we now manage history in analyze flow
  // keep for compatibility
  state.history = (state.history || []).concat([data]).slice(-50);
  state.currentRecord = data;
  renderHistory();
  saveAppState();
}

function renderHistory() {
  if (!state.history || state.history.length === 0) {
    historyList.innerHTML = `Ch∆∞a c√≥ b·∫£n ghi n√†o tr∆∞·ªõc ƒë√≥.`;
    return;
  }
  historyList.innerHTML = "";
  // show latest first
  const item = state.history[state.history.length - 1];
  const container = document.createElement("div");
  container.className = "history-item";
  const left = document.createElement("div"); left.className = "history-left";
  const main = document.createElement("div"); main.className = "history-line-main";

  const typePill = document.createElement("span");
  typePill.className = `pill ${item.inputType === "image" ? "pill-image" : "pill-video"}`;
  typePill.textContent = item.inputType === "image" ? "·∫¢nh" : "Video";

  const resultPill = document.createElement("span");
  resultPill.className = `pill pill-${item.label}`;
  resultPill.textContent = item.label === "live" ? "LIVE" : "SPOOF";

  const scoreSpan = document.createElement("span");
  scoreSpan.innerHTML = `<strong>Score:</strong> ${item.score !== null && item.score !== undefined ? Number(item.score).toFixed(3) : "N/A"}`;

  const modelSpan = document.createElement("span");
  modelSpan.className = "badge-model";
  modelSpan.textContent = item.model || modelSelect.options[modelSelect.selectedIndex].text;

  main.appendChild(typePill); main.appendChild(resultPill); main.appendChild(scoreSpan); main.appendChild(modelSpan);

  const ts = document.createElement("div");
  ts.className = "history-timestamp";
  ts.textContent = `${new Date(item.timestamp).toLocaleString()} ‚Ä¢ ${item.duration_ms !== undefined && item.duration_ms !== null ? `${item.duration_ms} ms` : ""}`;

  left.appendChild(main); left.appendChild(ts);
  container.appendChild(left);
  historyList.appendChild(container);
}

// clear history button
clearHistoryBtn.addEventListener("click", () => {
  state.history = [];
  state.currentRecord = null;
  renderHistory();
  saveAppState();
});

// beforeunload warning if unsaved / running
window.addEventListener("beforeunload", (e) => {
  const running = state.phase === "running";
  const hasFile = !!state.fileBlob;
  if (running || hasFile) {
    e.preventDefault();
    e.returnValue = "";
    return "";
  }
});

// initial load
window.addEventListener("DOMContentLoaded", async () => {
  await loadAppState();
  if (!state.fileBlob) {
    tryRestorePreviewImage();
  }
  renderPreviewPlaceholder();
});

</script>

  